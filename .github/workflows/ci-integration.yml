name: CI Integración (docker-compose)

on:
  push:
    branches: [ "main" ]
    paths:
      - "Sales-System/**"
      - ".github/workflows/ci-integration.yml"
  pull_request:
    branches: [ "main" ]
    paths:
      - "Sales-System/**"
      - ".github/workflows/ci-integration.yml"

jobs:
  compose-test:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    env:
      COMPOSE_FILE: Sales-System/docker-compose.yml

    steps:
      - uses: actions/checkout@v4

      - name: Verificar/instalar Docker Compose v2 si hiciera falta
        shell: bash
        run: |
          set -e
          if docker compose version >/dev/null 2>&1; then
            echo "docker compose ya disponible"
          else
            mkdir -p ~/.docker/cli-plugins
            curl -L "https://github.com/docker/compose/releases/download/v2.27.0/docker-compose-linux-x86_64" \
              -o ~/.docker/cli-plugins/docker-compose
            chmod +x ~/.docker/cli-plugins/docker-compose
            docker compose version
          fi

      - name: Build imágenes locales
        run: docker compose -f "$COMPOSE_FILE" build

      - name: Levantar stack
        run: docker compose -f "$COMPOSE_FILE" up -d

      - name: Esperar puertos (3306, 8081-8084)
        shell: bash
        run: |
          set -e
          for port in 3306 8081 8082 8083 8084; do
            echo "Esperando puerto $port..."
            for i in {1..60}; do
              if (echo > /dev/tcp/127.0.0.1/$port) >/dev/null 2>&1; then
                echo "Puerto $port OK"; break
              fi
              sleep 5
            done
          done

      - name: Smoke tests HTTP (tolerantes y con reintentos)
        shell: bash
        run: |
          set -e
          check_url () {
            local url="$1"
            code=$(curl -s -o /dev/null -w '%{http_code}' --max-time 5 "$url" || echo "000")
            echo "$url -> $code"
            if [ "$code" != "000" ]; then return 0; else return 1; fi
          }
          wait_service () {
            local base="$1"
            echo "Verificando $base ..."
            for i in {1..24}; do
              if check_url "$base/actuator/health" || check_url "$base/" || check_url "$base/api"; then
                echo "OK $base"
                return 0
              fi
              sleep 5
            done
            echo "Falla $base tras espera"
            return 1
          }
          wait_service http://localhost:8081
          wait_service http://localhost:8082
          wait_service http://localhost:8083
          wait_service http://localhost:8084

      - name: Logs (si falla)
        if: failure()
        run: docker compose -f "$COMPOSE_FILE" logs --no-color > compose-logs.txt || true

      - name: Artefacto logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compose-logs
          path: compose-logs.txt

      - name: Down
        if: always()
        run: docker compose -f "$COMPOSE_FILE" down -v
